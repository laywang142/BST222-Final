# Model Checking

## Assumption
The Schoenfeld residual plots and the cox.zph function are used to test the proportional hazards assumption for the Cox regression model. The models with race, smoke, and year of school have p-values of 0.29, 0.83, and 0.055 respectively, all of which are greater than 0.05.

```{r resa, fig.align='center', fig.height=3.5, message=FALSE, warning=FALSE, fig.cap="Schoenfeld Residuals for Race"}
plot(cox.zph(coxa))
```

```{r resb, fig.align='center', fig.height=3.5, message=FALSE, warning=FALSE, fig.cap="Schoenfeld Residuals for Smoke Status"}
plot(cox.zph(coxb))
```

```{r resc, fig.align='center', fig.height=3.5, message=FALSE, warning=FALSE, fig.cap="Schoenfeld Residuals for Year of School"}
plot(cox.zph(coxc))
```

The Schoenfeld residual plots shown in \@ref(fig:resa), \@ref(fig:resb), and \@ref(fig:resc) do not exhibit any clear signs of non-proportionality because the residuals are randomly distributed around the y=0 lines in both plots. These results suggest that the evidence is insufficient to conclude that the hazards are non-proportional for the two models. 

## Outliers

## outlier 
```{r}
dfb1 <- residuals(coxa,type="dfbeta")
dfb2 <- residuals(coxb,type="dfbeta")
dfb2 <- matrix(dfb2, ncol = 1)
dfb3 <- residuals(coxc,type="dfbeta")
```

```{r}
# dfbeta for race
plot(dfb1[,1],xlab="Observation Number",ylab="dfbeta for Race", 
     ylim=c(-.025,.01), pch = 19, cex = 0.5, col = "orange")
text(dfb1[,1]+.0015, labels = rownames(df), cex = 0.8)
title("dfbeta Values by Observation Number for Race")
```

```{r}
# dfbeta for smoke
plot(dfb2[,1],xlab="Observation Number",ylab="dfbeta for Smoke", 
     ylim=c(-.008,.025), pch = 19, cex = 0.5, col = "purple")
text(dfb2[,1]+.001, labels = rownames(df), cex = 0.8)
title("dfbeta Values by Observation Number for Smoke")
```

```{r}
# dfbeta for  yschool
plot(dfb3[,1],xlab="Observation Number",ylab="dfbeta for Year of School", 
     ylim=c(-.015,.022), pch = 19, cex = 0.5, col = "green")
text(dfb3[,1]+.0015, labels = rownames(df), cex = 0.8)
title("dfbeta Values by Observation Number for Year of School")
```

Dim for dfb2 is NULL!!!!!!!! WHYYYYYYYYYY


We used DFBETA to assess how the exclusion of a specific data point impacts the regression coefficients. The larger the absolute value of DFBETA  is, the more influential the point becomes and the greater the probability that it is an outlier. 

Observations 18, 353, 489, 518, 594, 684, 689, and 849 in our analysis deviate from the majority of the data points, indicating that these observations are likely to be outliers and need further investigation. The following table displays the detailed information of these unusual observations and will be discussed later. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
coxa_tbl <- summary(coxa)$coef
coxa_tbl  %>% 
  kableExtra::kable(caption = "\\label{tab:race_model}Coefficients for Race Model",
                    align = 'c',
                    booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position"), 
                    full_width = F, font_size = 10
                    )
```

```{r,results = 'asis',echo=FALSE,message=FALSE,warning=FALSE}
outlier = c(18, 353, 489, 518, 594, 684, 689, 849)
table_out <- df[outlier, ]
table_out  %>% 
  kableExtra::kable(caption = "\\label{tab:race_model}Unusual Observations Detail",
                    align = 'c',
                    booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position"), 
                    full_width = F, font_size = 10
                    )
```
