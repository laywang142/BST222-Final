---
title: "shirley"
author: "Shirley Lin"
date: "2023-11-28"
output: html_document
---

```{r}
library(KMsurv)
library(survival)
library(dplyr)
### We're using Bfeed from KMsurv
data(bfeed)
```

```{r}
# data processing
df <- bfeed %>% 
  mutate(race = case_when(race == 1 ~ "white",
                          race == 2 ~ "black", 
                          race == 3 ~ "other") %>% 
           factor(levels = c("white", "black", "other")),
         poverty = factor(poverty, levels = c(1,0), labels = c("yes", "no")),
         smoke = factor(smoke, levels = c(1,0), labels = c("yes", "no")),
         alcohol = factor(alcohol, levels = c(1,0), labels = c("yes", "no")),
         pc3mth = factor(pc3mth, levels = c(1,0), labels = c("yes", "no")),
         yschool = case_when(yschool < 12 ~ "noHS",
                             yschool == 12 ~ "HSgrad", 
                             yschool > 12 ~ "someCollege") %>% 
           factor(levels = c("noHS", "HSgrad", "someCollege"))
         )

str(df)

# survival object
surv <- Surv(df$duration, df$delta)
```

### KM curve

KM for race
```{r}
# check for stratification in race
KMcurves_race <- survfit(surv ~ race, data = df)
plot(KMcurves_race, col = 1:3, main = "KM Curves for Races")
legend("topright", legend = c("White", "Black", "Other"), col = 1:3, lty = 1)
```
some crossings


KM for poverty
```{r}
KMcurves_poverty <- survfit(surv ~ poverty, data = df)
plot(KMcurves_poverty, col = 1:2, main = "KM Curves for Poverty")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)
```
have apparent crossings


KM for smoke
```{r}
KMcurves_smoke <- survfit(surv ~ smoke, data = df)
plot(KMcurves_smoke, col = 1:2, main = "KM Curves for Smoke")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)
```
no apparent crossing


KM for alcohol
```{r}
KMcurves_alcohol <- survfit(surv ~ alcohol, data = df)
plot(KMcurves_alcohol, col = 1:2, main = "KM Curves for Alcohol")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)
```
no apparent crossings


KM for yschool
```{r}
# check for stratification in race
KMcurves_yschool <- survfit(surv ~ yschool, data = df)
plot(KMcurves_yschool, col = 1:3, main = "KM Curves for Education")
legend("topright", legend = c("noHS", "HSgrad", "comeCollege"), col = 1:3, lty = 1)
```
no apparent crossing


KM for pc3mth
```{r}
KMcurves_pc3mth <- survfit(surv ~ pc3mth, data = df)
plot(KMcurves_pc3mth, col = 1:2, main = "KM Curves for Prenatal Care")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)
```
have apparent crossings


### Model Building

```{r}
# full model with everything
cox1 <- coxph(surv ~ race+poverty+smoke+alcohol+agemth+yschool+pc3mth, data=df)
summary(cox1)
AIC(cox1)
drop1(cox1)


# add 2 strata
cox2 <- coxph(surv ~ race+smoke+alcohol+agemth+yschool+strata(poverty)+strata(pc3mth), data=df)
summary(cox2)
AIC(cox2)
drop1(cox2)

# remove agemth
cox3 <- coxph(surv ~ race+smoke+alcohol+yschool+strata(poverty)+strata(pc3mth), data=df)
summary(cox3)
AIC(cox3)
drop1(cox3)

# remove alcohol
cox4 <- coxph(surv ~ race+smoke+yschool+strata(poverty)+strata(pc3mth), data=df)
summary(cox4)
AIC(cox4)
drop1(cox4)


# check interaction
coxa <- coxph(surv ~ race*smoke*alcohol*agemth*yschool+strata(poverty)+strata(pc3mth), data=df)
summary(coxa)
AIC(coxa)

# remove non-significant interactions
coxb <- coxph(surv ~ race*smoke*alcohol*agemth*yschool+strata(poverty)+strata(pc3mth), data=df)
summary(coxb)
AIC(coxb)

# remove agemth
coxc <- coxph(surv ~ race*alcohol*yschool+smoke+strata(poverty)+strata(pc3mth), data=df)
summary(coxc)
AIC(coxc)
drop1(coxc)


# mix??
coxd <- coxph(surv ~ race*yschool+alcohol+smoke+strata(poverty)+strata(pc3mth), data=df)
summary(coxd)
AIC(coxd)
drop1(coxd)

```



