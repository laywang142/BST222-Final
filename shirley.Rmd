---
title: "shirley"
author: "Shirley Lin"
date: "2023-11-28"
output: html_document
---

```{r}
library(KMsurv)
library(survival)
library(dplyr)
### We're using Bfeed from KMsurv
data(bfeed)
```

```{r}
# data processing
df <- bfeed %>% 
  mutate(race = case_when(race == 1 ~ "white",
                          race == 2 ~ "black", 
                          race == 3 ~ "other") %>% 
           factor(levels = c("white", "black", "other"), ordered = F),
         poverty = factor(poverty, levels = c(1,0), labels = c("yes", "no")),
         smoke = factor(smoke, levels = c(1,0), labels = c("yes", "no")),
         alcohol = factor(alcohol, levels = c(1,0), labels = c("yes", "no")),
         pc3mth = factor(pc3mth, levels = c(1,0), labels = c("yes", "no")),
         yschool = case_when(yschool < 12 ~ "noHS",
                             yschool == 12 ~ "HSgrad", 
                             yschool > 12 ~ "someCollege") %>% 
           factor(levels = c("noHS", "HSgrad", "someCollege"), ordered = F)
         )

str(df)

# survival object
surv <- Surv(df$duration, df$delta)
```


### data visualization
```{r}
#barplot(df$yschool)
```


### KM curve

KM for race
```{r}
# check for stratification in race
KMcurves_race <- survfit(surv ~ race, data = df)
plot(KMcurves_race, col = 1:3, main = "KM Curves for Races")
legend("topright", legend = c("White", "Black", "Other"), col = 1:3, lty = 1)

survdiff(surv ~ race, data = df) #different processes
```
some crossings


KM for poverty
```{r}
KMcurves_poverty <- survfit(surv ~ poverty, data = df)
plot(KMcurves_poverty, col = 1:2, main = "KM Curves for Poverty")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)

survdiff(surv ~ poverty, data = df) #no difference
```
have apparent crossings

```{r}
inter.cox <- coxph(surv ~ (race+smoke+alcohol+agemth+yschool+pc3mth) *strata(Gender), data = burn1)
```



KM for smoke
```{r}
KMcurves_smoke <- survfit(surv ~ smoke, data = df)
plot(KMcurves_smoke, col = 1:2, main = "KM Curves for Smoke")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)

survdiff(surv ~ smoke, data = df) #different processes
```
no apparent crossing


KM for alcohol
```{r}
KMcurves_alcohol <- survfit(surv ~ alcohol, data = df)
plot(KMcurves_alcohol, col = 1:2, main = "KM Curves for Alcohol")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)

survdiff(surv ~ alcohol, data = df) #not different
```
no apparent crossings


KM for yschool
```{r}
# check for stratification in race
KMcurves_yschool <- survfit(surv ~ yschool, data = df)
plot(KMcurves_yschool, col = 1:3, main = "KM Curves for Education")
legend("topright", legend = c("noHS", "HSgrad", "comeCollege"), col = 1:3, lty = 1)

survdiff(surv ~ yschool, data = df) #some difference
```
no apparent crossing


KM for pc3mth
```{r}
KMcurves_pc3mth <- survfit(surv ~ pc3mth, data = df)
plot(KMcurves_pc3mth, col = 1:2, main = "KM Curves for Prenatal Care")
legend("topright", legend = c("Yes", "No"), col = 1:2, lty = 1)

survdiff(surv ~ pc3mth, data = df) #no difference
```
have apparent crossings


### Model Building

```{r}
# full model with everything
cox1 <- coxph(surv ~ race+poverty+smoke+alcohol+agemth+yschool+pc3mth, data=df)
summary(cox1)
AIC(cox1)
drop1(cox1)


cox2 <- coxph(surv ~ race+strata(poverty)+smoke+alcohol+agemth+yschool+strata(pc3mth), data=df)
summary(cox2)
AIC(cox2)
drop1(cox2)

cox3 <- coxph(surv ~ strata(race)+strata(poverty)+smoke+alcohol+agemth+yschool+strata(pc3mth), data=df)
summary(cox3)
AIC(cox3)
drop1(cox3)


cox4 <- coxph(surv ~ strata(race)+strata(poverty)+smoke+alcohol+agemth+yschool+strata(pc3mth), data=df)
summary(cox4)
AIC(cox4)
drop1(cox4)

cox5 <- coxph(surv ~ strata(race)+strata(poverty)+smoke+agemth+yschool+strata(pc3mth), data=df)
summary(cox5)
AIC(cox5)
drop1(cox5)


cox6 <- coxph(surv ~ strata(race)+strata(poverty)+smoke+yschool+strata(pc3mth), data=df)
summary(cox6)
AIC(cox6)
drop1(cox6)


cox7 <- coxph(surv ~ race+strata(poverty)+smoke+yschool+strata(pc3mth), data=df)
summary(cox7)
AIC(cox7)
drop1(cox7)

cox8 <- coxph(surv ~ race+yschool+smoke+strata(poverty)+strata(pc3mth), data=df)
summary(cox8)
AIC(cox8)
drop1(cox8)
BIC(cox8)

#cox.zph
sapply(1:8, function(x) {
  cox.zph(get(paste0("cox", x)))
})

#cox.zph
sapply(1:8, function(x) {
  cox.zph(get(paste0("cox", x)))
})

```



